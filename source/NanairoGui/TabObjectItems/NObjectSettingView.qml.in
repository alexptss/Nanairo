/*!
  \file NObjectSettingView.qml
  \author Sho Ikeda

  Copyright (c) 2015-2016 Sho Ikeda
  This software is released under the MIT License.
  http://opensource.org/licenses/mit-license.php
  */

import QtQuick @qt_quick_version@
import QtQuick.Controls @qt_quick_controls_version@
import ".."
import "../Styles"

Rectangle {
  id: object_setting_view

  property var emitterModel: null
  property var surfaceModel: null
  property var currentItem: null
  property bool isItemChangeMode: false

  width: @object_setting_view_width@
  height: @object_setting_view_height@

  TabView {
    id: object_tab_view

    x: 0
    y: 8
    width: object_setting_view.width
    height: object_setting_view.height - y

    style: tab_view_style
  
    Tab {
      title: "Camera"
      active: true
      enabled: isCameraObject(currentItem)
      NCameraTabItem {
        color: object_setting_view.color
      }
    }
 
    Tab {
      title: "Object"
      active: true
      enabled: isSingleObject(currentItem)
      NSingleObjectTabItem {
        color: object_setting_view.color
        emitterModel: object_setting_view.emitterModel
        surfaceModel: object_setting_view.surfaceModel
      }
    }
  
    Tab {
      title: "Group"
      active: true
      enabled: isGroupObject(currentItem)
      NGroupTabItem {
        color: object_setting_view.color
      }
    }
  
    Tab {
      title: "Transformation"
      active: true
      NTransformationTabItem {
        color: object_setting_view.color
      }
    }
  }

  Component {
    id: tab_view_style

    NTabViewStyle {
      backgroundColor: object_setting_view.color
    }
  }

  function isCameraObject(item) {
    return (item != null) && (item["type"] == "@cameraObject@");
  }

  function isSingleObject(item) {
    return (item != null) && (item["type"] == "@singleObject@");
  }

  function isGroupObject(item) {
    return (item != null) && (item["type"] == "@groupObject@");
  }

  function getObjectTabIndex(type) {
    // Check object type
    var tabIndex = -1;
    switch (type) {
      case "@cameraObject@":
        tabIndex = 0;
        break;
      case "@singleObject@":
        tabIndex = 1;
        break;
      case "@groupObject@":
        tabIndex = 2;
        break;
      default:
        console.assert(false, "Unsupported object type is specified: ", type);
        break;
    }
    return tabIndex;
  }

  function getObjectTab(tabIndex) {
    var objectTab = object_tab_view.getTab(tabIndex).item;
    return objectTab;
  }

  function initializeItem(item) {
    var objectType = item["type"];
    var tabIndex = getObjectTabIndex(objectType);
    var objectTab = getObjectTab(tabIndex);
    objectTab.initializeItem(item);
    var transformationTab = getObjectTab(3);
    transformationTab.initializeItem(item);
  }

  function reflectItem() {
    var item = currentItem;
    var tabIndex = getObjectTabIndex(item["type"]);
    var objectTab = getObjectTab(tabIndex);
    objectTab.reflectItem();
    object_tab_view.currentIndex = tabIndex;
  }

  function setCurrentItem(item, itemChangeMode) {
    currentItem = item;
    isItemChangeMode = itemChangeMode;
    for (var i = 0; i < object_tab_view.count; ++i) {
      var objectTab = getObjectTab(i);
      objectTab.setCurrentItem(item, itemChangeMode);
    }
  }

  function getItemData(item) {
    var objectTab = getObjectTab(getObjectTabIndex(item["type"]));
    var itemData = objectTab.getItemData(item);

    var transformationTab = getObjectTab(3);
    itemData["@transformation@"] = 
        transformationTab.getTransformationData(item["@transformation@"]);

    return itemData;
  }

  function makeItem(itemData) {
    var objectTab = getObjectTab(getObjectTabIndex(itemData["@type@"]));
    var item = objectTab.makeItem(itemData);

    var transformationTab = getObjectTab(3);
    item["@transformation@"] =
        transformationTab.makeTransformationItem(itemData["@transformation@"]);

    return item;
  }

  function addCameraEvent(matrix) {
    console.log("CameraEvent: ", matrix);
  }

  Connections {
    target: nanairoManager
    onCameraEventHandled: addCameraEvent(matrix)
  }
}
